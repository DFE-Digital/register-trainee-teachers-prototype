{% extends "_templates/_page.html" %}

{% set backLink = '/reports' %}
{% set backText = "Reports" %}
{% set navActive = 'reports' %}

{# {% set formAction = "./reinstate/confirm" %} #}

{% set academicYear = data.years.currentAcademicYear %}
{% set academicYearShort = data.years.currentAcademicYear | academicYearToYear %}

{% set previousAcademicYear = data.years.previousAcademicYear %}

{% set pageHeading = 'Trainees who studied in the ' + previousAcademicYear + ' academic year' %}

{% set performanceProfilesDate = "2023-1-31" %}

{% set viewingUserIsScitt = data.settings.userActiveProvider | providerIsScitt %}

{% if viewingUserIsScitt %}
  {% set traineeCount = 37 %}
{% else %}
  {% set traineeCount = 127 %}
{% endif %}


{% set hasZeroTraineesToExport = true if traineeCount == 0 %}

{% set filteredRecords      = data.records | filterRecords(data) %}

{# Exclude drafts #}
{% set registeredTrainees   = filteredRecords | filterByStatus("Draft", true) %}

{# Just trainees from the academic year #}
{% set academicYearTrainees          = registeredTrainees | whereIncludes('academicYears', previousAcademicYear) %}

{# Those that started that year #}
{% set newStarterTrainees            = academicYearTrainees | whereIncludes('academicYear', previousAcademicYear) %}

{# Those that were awarded in the year #}
{% set awardedTrainees               = academicYearTrainees | filterByFunction('isAwarded') | whereIncludes('endAcademicYear', previousAcademicYear) %}

{# Those that withdrew in the year #}
{% set withdrawnTrainees             = academicYearTrainees | filterByFunction('isWithdrawn') | whereIncludes('endAcademicYear', previousAcademicYear) %}

{# Those that withdrew within the first 90 days of starting #}
{% set withdrawnWithin90DaysTrainees = withdrawnTrainees | filterByFunction('withdrawnWithin90days')%}

{# Counts as links - not currently used #}
{# {% set totalTraineesCountLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}" class="govuk-link">
    {{academicYearTrainees | length}}<span class="_govuk-visually-hidden"> trainees</span>
  </a>
{% endset %}
{% set newStartersCountLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}&filterStartYears={{data.years.previousAcademicYear}}" class="govuk-link">
    {{newStarterTrainees | length}}<span class="_govuk-visually-hidden"> trainees</span>
  </a>
{% endset %}
{% set awardedCountLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}&filterEndYears={{data.years.previousAcademicYear}}&filterTrainingStatus=Awarded" class="govuk-link">
    {{awardedTrainees | length}}<span class="_govuk-visually-hidden"> trainees</span>
  </a>
{% endset %}
{% set withdrawnCountLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}&filterEndAcademicYear={{data.years.previousAcademicYear}}&filterTrainingStatus=Withdrawn" class="govuk-link">
    {{withdrawnTrainees | length}}<span class="_govuk-visually-hidden"> trainees</span>
  </a>
{% endset %}
 #}

{# Counts as links - not currently used #}
{# {% set yearCounts = [
  ["Total trainees", totalTraineesCountLink],
  ["New starters", newStartersCountLink],
  ["Awarded", awardedCountLink],
  ["Withdrawn", withdrawnCountLink]
]
%} #}

{# Labels as links #}

{% set totalTraineesLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}" class="govuk-link">
    Total trainees
  </a>
{% endset %}

{% set newStartersLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}&filterStartYears={{data.years.previousAcademicYear}}" class="govuk-link">
    New starters
  </a>
{% endset %}

{% set awardedLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}&filterEndYears={{data.years.previousAcademicYear}}&filterTrainingStatus=Awarded" class="govuk-link">
    Awarded
  </a>
{% endset %}

{% set withdrawnLink %}
  <a href="/records?&filterAcademicYears={{data.years.previousAcademicYear}}&filterEndAcademicYear={{data.years.previousAcademicYear}}&filterTrainingStatus=Withdrawn" class="govuk-link">
    Withdrawn
  </a>
{% endset %}

{% set yearCounts = [
  [totalTraineesLink, academicYearTrainees | length ],
  [newStartersLink, newStarterTrainees | length ],
  [awardedLink, awardedTrainees | length],
  [withdrawnLink, withdrawnTrainees | length]
]
%}

{% set yearSummaryTable %}
  {% from "govuk/components/table/macro.njk" import govukTable %}

  {# Convert array to array of objects that table macro needs #}
  {% set tableRows = yearCounts | arrayToGovukTable %}

  {% set tableCaption -%}
    Summary of the {{previousAcademicYear}} academic year
  {%- endset %}

  {{ govukTable({
    caption: tableCaption,
    captionClasses: "govuk-table__caption--m",
    firstCellIsHeader: false,
    head: [
      {
        text: "Type"
      },
      {
        text: "Number of trainees"
      }
    ],
    rows: tableRows
  }) }}
{% endset %}

{% block content %}
{{super()}}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds-from-desktop">
    <form action="" method="post">

      <h1 class="govuk-heading-l">{{pageHeading}}</h1>

      <p class="govuk-body">You can use this report to help you sign off your data for the initial teacher training (ITT) performance profiles publication.</p>

      <p class="govuk-body">You must check it, fix any mistakes and sign it off by 4pm on {{ performanceProfilesDate | govukDate('D MMMM YYYY') }}.</p>

      <p class="govuk-body">The export includes all trainees who:</p>

      <ul class="govuk-list govuk-list--bullet">
        <li>
          have been registered with the Department for Education
        </li>
        <li>
          studied in the {{ previousAcademicYear }} academic year
        </li>
      </ul>

      {{ yearSummaryTable | safe }}

      <h2 class="govuk-heading-m">Check your trainee data</h2>

      <p class="govuk-body">You need to check that:

      <ul class="govuk-list govuk-list--bullet">
        <li>
          all your 2020 to 2021 trainees are listed, including any who deferred or withdrew from the course
        </li>
        <li>
        the number of trainees awarded qualified teacher status (QTS) or early years teacher status (EYT) is accurate
        </li>
      </ul>

      <p class="govuk-body">For each trainee you need to check:</p>

      <ul class="govuk-list govuk-list--bullet">
        <li>
          course details
        </li>
        <li>
          status
        </li>
        <li>
          the date they were awarded QTS, deferred or withdrew from the course, unless they are still studying
        </li>
      </ul>

      <h2 class="govuk-heading-m">Fix mistakes</h2>

      <p class="govuk-body">If the trainee has been awarded or withdrawn, email <a class="govuk-link" href="mailto:becomingateacher@digital.education.gov.uk?subject=Accessibility%20issues%20">becomingateacher@digital.education.gov.uk</a>.</p>

      <p class="govuk-body">If the trainee is still studying or has deferred, how you fix a mistake depends on whether you registered the trainee using HESA or this service.</p>

      <h3 class="govuk-heading-s">Trainees registered using HESA</h3>

      <p class="govuk-body">TBD how to fix hesa trainees?</p>

      <h3 class="govuk-heading-s">Trainees registered using this service</h3>

      <p class="govuk-body">If the trainee is still studying or has deferred, you should update the their details with the correct information.</p>

      <h2 class="govuk-heading-m">Sign off your trainee data</h2>

      <p class="govuk-body">Once youâ€™ve checked your data, a senior person from your organisation should sign it off <a href="#" class="govuk-link">using this form (opens in a new tab)</a>.</p>

      <p class="govuk-body">You must sign off your data on or before {{ performanceProfilesDate | govukDate('dddd D MMMM YYYY') }}.</p>

      <p class="govuk-body">If you do not do this then your trainees may be excluded from the ITT performance profiles publication.</p>

      <h2 class="govuk-heading-m">How trainee data will be used in the ITT performance profiles publication</h2>

      <p class="govuk-body">Some trainees listed in this export will not be included in the ITT performance profiles publication. For example, trainees who withdrew within 90 days of the course start will not be included.</p>

      <p class="govuk-body">To find out how the data will be used, read the <a href="https://explore-education-statistics.service.gov.uk/methodology/initial-teacher-training-performance-profiles-methodology" class="govuk-link">Initial Teacher Training performance profiles methodology (opens in a new tab)</a>.</p>

      <p class="govuk-body">You need to check and sign off all the trainee data in the export.</p>

      <input name="successFlash" type="hidden" value="Export successfully downloaded">

      {% if hasZeroTraineesToExport %}
        {{ govukInsetText({
          text: "You have no trainees available to export. Check you have registered new trainees for the " + data.years.currentAcademicYear + " academic year."
        }) }}
      {% endif %}

      {% set buttonText -%}
        Export new trainee data ({{traineeCount}} {{"trainee" | pluralise(traineeCount)}})
      {%- endset %}

      {{ govukButton({
        "text": "Export new trainee data (CSV)",
        "text": buttonText
      }) }}

    </form>
  </div>
</div>

{% endblock %}
