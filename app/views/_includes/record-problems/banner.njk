{% set hasProblems = record | recordHasProblem %}
{% set recordProblems = record | getProblems %}
{% set isIncomplete = record | hasOutstandingActions %}
{% set countOfIssues = recordProblems | length %}

{# Combine incomplete with problems to get a total count #}
{% if isIncomplete %}
  {% set countOfIssues = countOfIssues + 1 %}
{% endif %}

{% if hasProblems %}
  {{recordProblems | log("Record problems:")}}
{% endif %}

{% set recordType = "record" if navActive == "records" else "draft" %}

{% if (countOfIssues > 0) and canAmend %}

  {# Correctly pluralise the title #}
  {% set title %}
    {% if countOfIssues == 1 %}
      This trainee {{ recordType }} has a problem
    {% else %}
      This trainee {{ recordType }} has problems
    {% endif %}
  {% endset %}

  {% set problemItems = [] %}

  {% for problem in recordProblems | sort(attribute='type') %}

    {% set problemHtml %}
      {% include "_includes/record-problems/" + problem.type + ".njk" %}
    {% endset %}

    {% set problemItems = problemItems | push({
      html: problemHtml | safe
    }) %}
    
  {% endfor %}

  {# Add incomplete to the end #}
  {% if isIncomplete %}
    {% set problemHtml %}
      {% include "_includes/record-problems/incomplete.njk" %}
    {% endset %}

    {% set problemItems = problemItems | push({
      html: problemHtml | safe
    }) %}
  {% endif %}

  {{ appNoticeBanner({
    titleText: title,
    itemList: problemItems
  }) }}

{% endif %}
