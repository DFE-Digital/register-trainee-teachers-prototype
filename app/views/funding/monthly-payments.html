{% extends "layout.html" %}
{% set navActive = "funding" %}

{% block content %}

  {% set pageHeading = "Funding 2021 to 2022" %}

  {% set yearPaymentsTabName = "" | typesOfFunding | joinify  | sentenceCase %}
  {% set activeTabMonthly = true %}
  {% include "_includes/funding-header-and-tab-nav.html" %}

  {% if accessLevel == 'accreditingProvider' %}
    {% set dataSource = data.funding.monthlyFundingScitts %}
  {% else %}
    {% set dataSource = data.funding.monthlyFundingLeadSchools %}
  {% endif %}
  {% set dataSource = dataSource | sort(attribute = "description") %}

  {% if dataSource.length > 4 %}
    {% set tableClasses = "govuk-!-font-size-16" %}
  {% endif %}

  {% set headRow = [{ text: "Month" }] %}
  {% for item in dataSource %}
    {% set headRow = headRow | push({ text: item.description | fixNamesFromFunding | sentenceCase | formatYearRange | safe }) %}
  {% endfor %}
  {% set headRow = headRow | push({ text: "Total" }) %}

  {% set rowsPast = [] %}
  {% set pastTotal = 0 %}

  {% set rowsFuture = [] %}
  {% set futureTotal = 0 %}

  {% set months  = [
    "August",
    "September",
    "October",
    "November",
    "December",
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July"
  ]%}

  {% if currentMonth() >= 8 %}
    {% set thisMonth = currentMonth() - 8 %}
  {% else %}
    {% set thisMonth = currentMonth() + 4 %}
  {% endif %}

  {% for item in months %}
    {% set monthIndex = loop.index0 %}
    {% set monthTotal = 0 %}
    {% set row = [{ text: months[monthIndex]}] %}
    {% for paymentType in dataSource %}
      {% if paymentType.monthlyPayments[monthIndex] == 0 %}
        {% set amount = "–" %}
      {% else %}
        {% set amount = paymentType.monthlyPayments[monthIndex] | currency %}
      {% endif %}
      {% set monthTotal = monthTotal + paymentType.monthlyPayments[monthIndex] %}
      {% set row = row | push({ text: amount, format: "numeric" }) %}
    {% endfor %}
    {% if monthTotal != 0 %}
      {% set row = row | push({ text: monthTotal | currency, format: "numeric" }) %}
    {% else %}
      {% set row = row | push({ text: "–", format: "numeric" }) %}
    {% endif %}
    {% if thisMonth >= loop.index0 %}
      {% set pastTotal = pastTotal + monthTotal %}
      {% set rowsPast = rowsPast | push(row) %}
    {% else %}
      {% set futureTotal = futureTotal + monthTotal %}
      {% set rowsFuture = rowsFuture | push(row) %}
    {% endif %}
  {% endfor %}

  {% set summaryRows = [] %}
  {% if thisMonth != 11 %}
    {% set summaryRowItems = [
      { text: "Payments to " + currentMonth("nameOfMonth") + " " + currentYear() }, 
      { text: pastTotal | currency, format: "numeric" }] 
    %}
    {% set summaryRows = summaryRows | push(summaryRowItems) %}
    {% set summaryRowItems = [
      { text: "Predicted payments" }, 
      { text: futureTotal | currency, format: "numeric" }] 
    %}
    {% set summaryRows = summaryRows | push(summaryRowItems) %}
    {% set summaryRowItems = [{ text: "Predicted total" }, { text: (pastTotal + futureTotal) | currency, format: "numeric" }] %}
    {% set summaryRows = summaryRows | push(summaryRowItems) %}
  {% else %}
    {% set summaryRowItems = [{ text: "Total for year" }, { text: pastTotal | currency, format: "numeric" }] %}
    {% set summaryRows = summaryRows | push(summaryRowItems) %}
  {% endif %}


  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">
      <h2 class="govuk-heading-l">
        Monthly payments
      </h2>
      <p class="govuk-body govuk-!-margin-bottom-1">
        Last updated: {{ "" | yesterdayGovuk }}
      </p>
      <p>
        <a href="#" class="govuk-link--no-visited-state">Export monthly payments</a>
      </p>
    </div>
  </div>

  <hr class="govuk-section-break govuk-section-break--m">

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-half-from-desktop">
      {{ govukTable({
        caption: "Summary",
        captionClasses: "govuk-table__caption--m",
        head: [
                {
                  text: "Payment type"
                },
                {
                  text: "Amount",
                  classes: "app-table__column-25"
                }
              ],
        rows: summaryRows
      }) }}
    </div>
  </div>
  <hr class="govuk-section-break govuk-section-break--m">
  <div class="govuk-grid-row">
    {% if dataSource.length < 6 %}
      <div class="govuk-grid-column-full">

        {# Single table showing all months #}
        {{ govukTable({
          caption: "Payments to " + currentMonth("nameOfMonth") + " " + currentYear(),
          captionClasses: "govuk-table__caption--m",
          classes: tableClasses,
          head: headRow,
          rows: rowsPast
        }) }}

        {# 11th month = July (12 months of the Academic year 0 indexed) #}

        {% if thisMonth != 11 %}
          <hr class="govuk-section-break govuk-section-break--m">
          {{ govukTable({
            caption: "Predicted payments",
            captionClasses: "govuk-table__caption--m",
            classes: tableClasses,
            head: headRow,
            rows: rowsFuture
          }) }}
        {% endif %}
      </div>
    {% else %}
      <div class="govuk-grid-column-two-thirds-from-desktop">
        {% set pastTables = [] %}
        {% set futureTables = [] %}

        {% for item in months %}
          {% set monthTableRows  = [] %}
          {% set monthIndex = loop.index0 %}
          {% set monthTableCaption = months[monthIndex] %}
          {% set monthTotal = 0 %}
          {% set cumulativeMonthTotal = 0 %}
          {% for item in dataSource %}
            {% set rowIndex = loop.index0 %}
            {% set paymentDescription = item.description | fixNamesFromFunding | sentenceCase | formatYearRange %}
            {% set monthTotal = monthTotal + item.monthlyPayments[monthIndex] %}
            {% set cumulativeMonthTotal = cumulativeMonthTotal + item.cumulativeMonthlyPayments[monthIndex] %}
            {% if item.monthlyPayments[monthIndex] != "" %}
              {% set amount = item.monthlyPayments[monthIndex] | currency %}
            {% else %}
              {% set amount = "–" %}
            {% endif %}
            {% if item.cumulativeMonthlyPayments[monthIndex] != "" %}
              {% set cumulativeAmount = item.cumulativeMonthlyPayments[monthIndex] | currency %}
            {% else %}
              {% set cumulativeAmount = "–" %}
            {% endif %}
            {% set row = [
              { text: paymentDescription | safe },
              { text: amount, format: "numeric" },
              { text: cumulativeAmount, format: "numeric" }
            ] %}
            {% set monthTableRows = monthTableRows | push(row) %}
          {% endfor %}
          {% set monthTableRows = monthTableRows | push([
            { text: "Total", classes: "govuk-!-font-weight-bold" }, 
            { text: monthTotal | currency, format: "numeric", classes: "govuk-!-font-weight-bold" },
            { text: cumulativeMonthTotal | currency, format: "numeric", classes: "govuk-!-font-weight-bold" }
          ])%}
          {% if loop.index0 <= thisMonth and cumulativeMonthTotal != 0 %}
            {% set monthTableHtml %}
              {{ govukTable({
                caption: monthTableCaption,
                captionClasses: "govuk-table__caption--m",
                classes: tableClasses,
                head: [
                  {
                    text: "Payment type"
                  },
                  {
                    text: "Amount",
                    format: "numeric",
                    classes: "app-table__column-15"
                  },
                  {
                    text: "Total for payment type",
                    format: "numeric",
                    classes: "app-table__column-15"
                  }
                ],
                rows: monthTableRows
              }) }}
            {% endset %}
            {% set pastTables = pastTables | push(monthTableHtml) %}
          {% elseif cumulativeMonthTotal != 0 %}
            {% set monthTableHtml %}
              {{ govukTable({
                caption: monthTableCaption,
                captionClasses: "govuk-table__caption--m",
                classes: tableClasses,
                head: [
                  {
                    text: "Payment type"
                  },
                  {
                    text: "Amount",
                    format: "numeric",
                    classes: "app-table__column-15"
                  },
                  {
                    text: "Total for payment type",
                    format: "numeric",
                    classes: "app-table__column-15"
                  }
                ],
                rows: monthTableRows
              }) }}
            {% endset %}
            {% set futureTables = futureTables | push(monthTableHtml) %}
          {% endif %}
        {% endfor %}



        {# Table per month #}
        <h3 class="govuk-heading-m">Payments to {{ currentMonth("nameOfMonth") }} {{ currentYear() }}</h3>
        {% for item in pastTables %}
          {{ item | safe }}
        {% endfor %}
        {% if thisMonth != 11 %}
          <hr class="govuk-section-break govuk-section-break--m">
          <h3 class="govuk-heading-m">Predicted payments</h3>
          {% for item in futureTables %}
            {{ item | safe }}
          {% endfor %}
        {% endif %}
      {% endif %}
    </div>
  </div>

{% endblock %}
